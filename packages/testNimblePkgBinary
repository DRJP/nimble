#!/bin/sh -xe

# 
# This builds a binary version of the package from source and hence creates a .gz file (.tar.gz or .tgz depending on the platform) 
# Then it installs this binary version of the package and runs a test of nimble using that installed version.
# This will have to find libnimble.a when compiling the DLL for the model generated in the test.


# This is to be run from a directory parallel to the nimble/ directory containing the package.
# mkdir Temp
# cd Temp
# ../testNimblePkgBinary
#
#

# This script will result in uninstalling nimble from standard installation location so that that one will not inadvertently mask a failure

(cd ../nimble ; ./cleanup)
Rscript -e 'remove.packages("nimble")'

# test default build from tarball for use on build machine:
echo "** testing default build from tarball for use on build machine"
R CMD BUILD ../nimble
R CMD INSTALL nimble_0.6.tar.gz
Rscript -e 'library(methods); library("nimble"); print(system.file(package = "nimble")); testBUGSmodel("pump")'

# test default build from directory for use on build machine:
echo "** testing default build from directory for use on build machine"
(cd ../nimble ; ./cleanup)
Rscript -e 'remove.packages("nimble")'
R CMD INSTALL ../nimble
Rscript -e 'library(methods); library("nimble", lib.loc = "RTempLib"); print(system.file(package = "nimble")); testBUGSmodel("pump")'

echo "** moving a copy of Eigen to this Temp directory to test user-provided eigen"
echo "** testing default build from tarball with user-provided eigen"
echo "** testing default build from directory with user-provided eigen"

echo "** testing build with --enable-dylib=true from tarball"
echo "** testing build with --enable-dylib=true built in directory"
echo "** testing build with --enable-dylib=true from tarball with user-provided eigen"
echo "** testing build with --enable-dylib=true built in directory with user-provided eigen (shouldn't work)"

echo "** testing default binary build with different locations (needed to work across machines)"
echo "** Building nimble binary package"
if ! test -d RTempLib ; then
  mkdir RTempLib
fi

CONFIG_ARGS="'--enable-lib=false'"
R CMD INSTALL  --configure-args="$CONFIG_ARGS" --build ../nimble
Rscript -e 'remove.packages("nimble")'

GZ=`ls nimble_*gz`
echo "** Installing nimble binary package $GZ"
R CMD INSTALL -l RTempLib $GZ

echo "Running testBUGSmodel()"
Rscript -e 'library(methods); library("nimble", lib.loc = "RTempLib"); print(system.file(package = "nimble")); testBUGSmodel("pump")'
